---
title: "lucas_analysis"
output: html_document
---

```{r loading packages}
suppressWarnings(suppressPackageStartupMessages(library(tidyverse)))
suppressWarnings(suppressPackageStartupMessages(library(survival)))
```

```{r loading data}
actg_c <- readRDS('../data/actg_clean.rds')
```

```{r KM Curves}
surv_actg <- Surv(actg_c$time_event, actg_c$event)

survfit_actg <- survfit(surv_actg ~ tx, data = actg_c)
survfit_na_actg <- survfit(surv_actg ~ tx, data = actg_c, type = 'fleming-harrington')

survfit_actg |> 
  plot(main = "Disease Free Survival for Soc and Invidir",
       col = 1:2, lwd = 2,
       conf.int = TRUE,
       xlab = 'Days',
       ylab = 'Survival Prob.',
       ylim = c(0.7, 1))
legend('bottomleft', c('SoC', 'SoC + Invidir'), col = 1:2, lwd = 2)

survfit_actg |> 
  plot(main = 'KM vs. AE Curve',
       col = 1:2, lwd = 2,
       xlab = 'days',
       ylab = 'Survival Prob',
       ylim = c(0.7, 1))
lines(survfit_na_actg, col = 3:4)
legend('bottomleft', c('KM Soc', 'KM SoC + Invidir', 'AE SoC', 'AE SoC + Invidir'), col = c(1:4), lwd = 1)
```

We see the AE and KM curves to be identical

```{r testing hypothesis}
survdiff(surv_actg ~ tx, data = actg_c)
```

From the Mantzel-Haeznel Test, we see there to be a difference in the two treatments. We should investigate this with cox model for proportional hazards.

```{r small model}
small_cox_actg <- coxph(surv_actg ~ tx, data = actg)
summary(small_cox_actg)
```

```{r large model}
large_cox_actg <- coxph(surv_actg ~ tx + sex + hemophil + karnof + priorzdv + age + race + base_cd4, data = actg_c)
summary(large_cox_actg)
```

Lets see if proportionality holds for this large model, and then investigate residuals if needed to tighten it up before we start dropping or 

```{r checking proportionality}
plot(survfit_na_actg,
     col = 1:2, lwd = 2,
     fun = 'cloglog',
     main = 'Complimentary Log-Log Survival Curves')
legend('topleft', c('SoC', 'SoC + Invidir'), col = 1:2, lwd = 2)

plot(survfit_na_actg)
# work on observed vs. expected survival curves to check proportionality of both small and large model
```

We see that proportionality blah blah blah, lines pretty parallel, time to investigate residuals to see if some can improve this assumption, and what other variable/dataset modifications can make our model stronger

```{r residuals to tighten up model}

```