---
title: "lucas_analysis"
output: html_document
---

```{r loading packages}
suppressWarnings(suppressPackageStartupMessages(library(tidyverse)))
suppressWarnings(suppressPackageStartupMessages(library(survival)))
```

```{r loading data}
actg_c <- readRDS('../data/actg_clean.rds')
```

```{r KM Curves}
surv_actg <- Surv(actg_c$time_event, actg_c$event)

survfit_actg <- survfit(surv_actg ~ tx, data = actg_c)
survfit_na_actg <- survfit(surv_actg ~ tx, data = actg_c, type = 'fleming-harrington')

survfit_actg |> 
  plot(main = "Disease Free Survival for Soc and Invidir",
       col = 1:2, lwd = 2,
       conf.int = TRUE,
       xlab = 'Days',
       ylab = 'Survival Prob.',
       ylim = c(0.7, 1))
legend('bottomleft', c('SoC', 'SoC + Invidir'), col = 1:2, lwd = 2)

survfit_actg |> 
  plot(main = 'KM vs. AE Curve',
       col = 1:2, lwd = 2,
       xlab = 'Days',
       ylab = 'Survival Prob',
       ylim = c(0.7, 1))
lines(survfit_na_actg, col = 3:4)
legend('bottomleft', c('KM Soc', 'KM SoC + Invidir', 'AE SoC', 'AE SoC + Invidir'), col = c(1:4), lwd = 1)
```

We see the AE and KM curves to be identical

```{r testing hypothesis}
survdiff(surv_actg ~ tx, data = actg_c)
```

From the Mantzel-Haeznel Test, we see there to be a difference in the two treatments. We should investigate this with cox model for proportional hazards.

```{r small model}
small_cox_actg <- coxph(surv_actg ~ tx, data = actg_c)
summary(small_cox_actg)
```

```{r large model}
large_cox_actg <- coxph(surv_actg ~ tx + sex + hemophil + ivdrug + karnof + priorzdv + age + race + base_cd4, data = actg_c)
summary(large_cox_actg)
```

Lets see if proportionality holds for this large model, and then investigate residuals if needed to tighten it up before we start dropping or 

```{r checking proportionality}
plot(survfit_na_actg,
     col = 1:2, lwd = 2,
     fun = 'cloglog',
     main = 'Complimentary Log-Log Survival Curves')
legend('topleft', c('SoC', 'SoC + Invidir'), col = 1:2, lwd = 2)

plot(survfit_na_actg, col = 1:2, lwd = 2, ylim = c(0.7, 1), main = 'Observed vs. Expected Survival (Small Model)',
     xlab = 'Days',
     ylab = 'Survival Prob.')
lines(survfit(small_cox_actg, data.frame(tx = c(0, 1)), data = actg_c),
      col = 1:2, lwd = 2, lty = 2)
legend('bottomleft', c('SoC', 'SoC + Invidir'), col = 1:2, lwd = 2)

mode_stat <- function(v) names(which.max(table(v)))

large_model_df <- data.frame(tx = c(0, 1),
                             sex = c('male', 'male'),
                             ivdrug = c('never', 'never'),
                             hemophil = c(0, 0),
                             karnof = c(mode_stat(actg_c$karnof[actg_c$tx == 0]), mode_stat(actg_c$karnof[actg_c$tx == 1])),
                             priorzdv = c(mean(actg_c$priorzdv[actg_c$tx == 0]), mean(actg_c$priorzdv[actg_c$tx == 1])),
                             age = c(mean(actg_c$age[actg_c$tx == 0]), mean(actg_c$age[actg_c$tx == 1])),
                             race = c(mode_stat(actg_c$race[actg_c$tx == 0]), mode_stat(actg_c$race[actg_c$tx == 1])),
                             base_cd4 = c(mean(actg_c$base_cd4[actg_c$tx == 0]), mean(actg_c$base_cd4[actg_c$tx == 1])))

plot(survfit_na_actg, col = 1:2, lwd = 2, ylim = c(0.7, 1), main = 'Observed vs. Expected Survival (Large Model)',
     xlab = 'Days',
     ylab = 'Survival Prob.')
lines(survfit(large_cox_actg, large_model_df, data = actg_c),
      col = 1:2, lwd = 2, lty = 2)
legend('bottomleft', c('SoC', 'SoC + Invidir'), col = 1:2, lwd = 2)
```

We see that proportionality seems to hold in our cloglog plot. Looking at the observed vs. expected survival curves, we see that a small model fits the observed survival much better than our large model does, pointing in the direction that a small model will be better. Drop1 will likely not be very effective, as there will be a lot to change, ie combinations of dropping, so we will investigate residuals to see which variables are causing problems and then remove them from the model, as well as which variables can be modified to keep our assumptions strong (linearity, etc.)

```{r schoenfeld residuals for proportionality}
large_model_zph <- 
  cox.zph(large_cox_actg)

large_model_zph

plot(large_model_zph[1],
     main = 'Plot of Schoenfeld Residuals',
     xlab = 'Time',
     ylab = 'Treatment')

plot(large_model_zph[2],
     main = 'Plot of Schoenfeld Residuals',
     xlab = 'Time',
     ylab = 'Sex')

plot(large_model_zph[3],
     main = 'Plot of Schoenfeld Residuals',
     xlab = 'Time',
     ylab = 'Hemophilia')

plot(large_model_zph[4],
     main = 'Plot of Schoenfeld Residuals',
     xlab = 'Time',
     ylab = 'IV Drug Usage')

plot(large_model_zph[5],
     main = 'Plot of Schoenfeld Residuals',
     xlab = 'Time',
     ylab = 'Karnofsky Score')

plot(large_model_zph[6],
     main = 'Plot of Schoenfeld Residuals',
     xlab = 'Time',
     ylab = 'Prior ZDV Use (Months)')

plot(large_model_zph[7],
     main = 'Plot of Schoenfeld Residuals',
     xlab = 'Time',
     ylab = 'Age')

plot(large_model_zph[8],
     main = 'Plot of Schoenfeld Residuals',
     xlab = 'Time',
     ylab = 'Race')

plot(large_model_zph[9],
     main = 'Plot of Schoenfeld Residuals',
     xlab = 'Time',
     ylab = 'Base CD4')
```

None of the variables bring up an apparent proportionality issue in the model graphically, although base_cd4 and age are questionable from their p-values.

```{r martingale residuals for transformations}

```

```{r cox-snell residuals for goodness of fit}

```