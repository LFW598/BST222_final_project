---
title: "lucas_analysis"
output: html_document
---

```{r loading packages}
suppressWarnings(suppressPackageStartupMessages(library(tidyverse)))
suppressWarnings(suppressPackageStartupMessages(library(survival)))

mode_stat <- function(v) names(which.max(table(v)))
```

```{r loading data}
actg_c <- readRDS('/Users/yyf/Desktop/UCDavis/BST222/Final_PJ/actg_clean.rds')
```

```{r KM Curves}
surv_actg <- Surv(actg_c$time_event, actg_c$event)

survfit_actg <- survfit(surv_actg ~ tx, data = actg_c)
survfit_na_actg <- survfit(surv_actg ~ tx, data = actg_c, type = 'fleming-harrington')

survfit_actg |> 
  plot(main = "Disease Free Survival for Soc and Invidir",
       col = 1:2, lwd = 2,
       conf.int = TRUE,
       xlab = 'Days',
       ylab = 'Survival Prob.',
       ylim = c(0.7, 1))
legend('bottomleft', c('SoC', 'SoC + Invidir'), col = 1:2, lwd = 2)

survfit_actg |> 
  plot(main = 'KM vs. AE Curve',
       col = 1:2, lwd = 2,
       xlab = 'Days',
       ylab = 'Survival Prob',
       ylim = c(0.7, 1))
lines(survfit_na_actg, col = 3:4)
legend('bottomleft', c('KM Soc', 'KM SoC + Invidir', 'AE SoC', 'AE SoC + Invidir'), col = c(1:4), lwd = 1)
```

We see the AE and KM curves to be identical

```{r testing hypothesis}
survdiff(surv_actg ~ tx, data = actg_c)
```

From the Mantzel-Haeznel Test, we see there to be a difference in the two treatments. We should investigate this with cox model for proportional hazards.

```{r small model}
small_cox_actg <- coxph(surv_actg ~ tx, data = actg_c)
summary(small_cox_actg)
```

```{r large model}
large_cox_actg <- coxph(surv_actg ~ tx + sex + hemophil + ivdrug + karnof + priorzdv + age + race + base_cd4, data = actg_c)
summary(large_cox_actg)
```

Lets see if proportionality holds for this large model, and then investigate residuals if needed to tighten it up before we start dropping variables, or adding to the large one. 

```{r checking proportionality}
plot(survfit_na_actg,
     col = 1:2, lwd = 2,
     fun = 'cloglog',
     main = 'Complimentary Log-Log Survival Curves')
legend('topleft', c('SoC', 'SoC + Invidir'), col = 1:2, lwd = 2)

plot(survfit_actg, col = 1:2, lwd = 2, ylim = c(0.7, 1), main = 'Observed vs. Expected Survival (Small Model)',
     xlab = 'Days',
     ylab = 'Survival Prob.')
lines(survfit(small_cox_actg, data.frame(tx = c(0, 1)), data = actg_c),
      col = 1:2, lwd = 2, lty = 2)
legend('bottomleft', c('SoC', 'SoC + Invidir'), col = 1:2, lwd = 2)

large_model_df <- data.frame(tx = c(0, 1),
                             sex = c('male', 'male'),
                             ivdrug = c('never', 'never'),
                             hemophil = c(0, 0),
                             karnof = c(mode_stat(actg_c$karnof[actg_c$tx == 0]), mode_stat(actg_c$karnof[actg_c$tx == 1])),
                             priorzdv = c(median(actg_c$priorzdv[actg_c$tx == 0]), median(actg_c$priorzdv[actg_c$tx == 1])),
                             age = c(mean(actg_c$age[actg_c$tx == 0]), mean(actg_c$age[actg_c$tx == 1])),
                             race = c(mode_stat(actg_c$race[actg_c$tx == 0]), mode_stat(actg_c$race[actg_c$tx == 1])),
                             base_cd4 = c(median(actg_c$base_cd4[actg_c$tx == 0]), median(actg_c$base_cd4[actg_c$tx == 1])))

plot(survfit_actg, col = 1:2, lwd = 2, ylim = c(0.7, 1), main = 'Observed vs. Expected Survival (Large Model)',
     xlab = 'Days',
     ylab = 'Survival Prob.')
lines(survfit(large_cox_actg, large_model_df, data = actg_c),
      col = 1:2, lwd = 2, lty = 2)
legend('bottomleft', c('SoC', 'SoC + Invidir'), col = 1:2, lwd = 2)
```

We see that proportionality seems to hold in our cloglog plot. Looking at the observed vs. expected survival curves, we see that a small model fits the observed survival much better than our large model does, pointing in the direction that a small model will be better. Drop1 will likely not be very effective, as there will be a lot to change, ie combinations of dropping, so we will instead try add1, and wremove variables that seem obviously unhelpful, and then investigate residuals to see which variables are causing problems and then remove them from the model, as well as which variables can be modified to keep our assumptions strong (linearity, etc.).

```{r add1}
add1(small_cox_actg, scope = ~ tx + sex + hemophil + ivdrug + karnof + priorzdv + age + race + base_cd4, test = "Chisq")
```

We see that keeping the karnofsky score, base_cd4, and age are helpful to the model, ivdrug use and priorzdv are borderline, so we will keep those as well and see if there are any transformations we can work with. We also have clinical reasons to believe priorzdv may be helpful in prediction, as it's a crucial part in the standard of care

```{r mid model summary}
mid_cox_actg <- coxph(surv_actg ~ tx + ivdrug + karnof + priorzdv + age + base_cd4, data = actg_c)
summary(mid_cox_actg)
```

```{r ivdrug edit}
table(actg_c$ivdrug)

mid_cox_actg <- coxph(surv_actg ~ tx + ivdrug_bin + karnof + priorzdv + age + base_cd4, data = actg_c)
summary(mid_cox_actg)
```

```{r reduced model (without priorzdv)}
cox_reduced <- coxph(surv_actg ~ tx + ivdrug_bin + karnof + age + base_cd4, data = actg_c)
anova(cox_reduced, mid_cox_actg, test = "LRT")
anova(cox_reduced, mid_cox_actg, test = "Rao")
```

The priorzdv variable does seem to be meaningless to the model, so we don't need to keep it in for now. 


```{r schoenfeld residuals for proportionality}
mid_model_zph <- 
  cox.zph(mid_cox_actg)

mid_model_zph

plot(mid_model_zph[1],
     main = 'Plot of Schoenfeld Residuals',
     xlab = 'Time',
     ylab = 'Treatment')

plot(mid_model_zph[2],
     main = 'Plot of Schoenfeld Residuals',
     xlab = 'Time',
     ylab = 'IVDrug Binary')

plot(mid_model_zph[3],
     main = 'Plot of Schoenfeld Residuals',
     xlab = 'Time',
     ylab = 'Karnofsky Score')

plot(mid_model_zph[4],
     main = 'Plot of Schoenfeld Residuals',
     xlab = 'Time',
     ylab = 'Prior ZDV Use (Months)')

plot(mid_model_zph[5],
     main = 'Plot of Schoenfeld Residuals',
     xlab = 'Time',
     ylab = 'Age')

plot(mid_model_zph[6],
     main = 'Plot of Schoenfeld Residuals',
     xlab = 'Time',
     ylab = 'Base_cd4 (mm^3)')
```

None of the variables bring up super apparent proportionality issues graphically, but based on p-values, base_cd4 is borderline.

```{r martingale residuals for transformations}
mres_priorzdv <- residuals(coxph(surv_actg ~ tx + ivdrug_bin + karnof + age + base_cd4, data = actg_c))
mres_age <- residuals(coxph(surv_actg ~ tx + ivdrug_bin + karnof + priorzdv + base_cd4, data = actg_c))
mres_basecd4 <- residuals(coxph(surv_actg ~ tx + ivdrug_bin + karnof + priorzdv + age, data = actg_c))

plot(actg_c$priorzdv, mres_priorzdv,
     xlab = 'Months of Prior ZDV',
     ylab = 'Martingale Residuals',
     main = 'Martingale Residuals vs. ZDV Usage')
lines(lowess(actg_c$priorzdv, mres_priorzdv))

plot(actg_c$age, mres_age,
     xlab = 'Age',
     ylab = 'Martingale Residuals',
     main = 'Martingale Residuals vs. Age')
lines(lowess(actg_c$age, mres_age))

plot(actg_c$base_cd4, mres_basecd4,
     xlab = 'Base cd4',
     ylab = 'Martingale Residuals',
     main = 'Martingale Residuals vs. Base cd4')
lines(lowess(actg_c$base_cd4, mres_basecd4))
```

No linear transformations necessary it looks like from the martingale residuals at least

```{r cox-snell residuals for goodness of fit}
mart_actg <- residuals(mid_cox_actg, type = 'martingale')
cs_actg <- actg_c$event - mart_actg

surv_cs <- survfit(Surv(cs_actg, actg_c$event) ~ 1, type = 'fleming-harrington')
plot(surv_cs, fun = 'cumhaz',
     main = 'Cumulative Hazard of Cox-Snell Residuals')
abline(0, 1, col = 'red')
```

We don't see a lack of fit from this procedure. There don't seem to be any obvious ways of changing the large model to get a consistently better fit. Lastly, lets investigate interaction terms between variables.

It seems logical that age and karnofsky score would have an interaction. A 60 year olf with a score of 100 is likely less resiliant to disease than a 25 year old with a score of 100.

```{r karnofsky score and age}
summary(mid_cox_actg)
summary(coxph(surv_actg ~ tx + ivdrug_bin + priorzdv + base_cd4 + (age * karnof), data = actg_c))

mres_mid <- residuals(mid_cox_actg, type = 'martingale')

plot((actg_c$age * as.numeric(actg_c$karnof)), mres_mid,
     xlab = 'Age * Karnofsky Score',
     ylab = 'Martingale Residuals',
     main = 'Martingale Residuals vs. Age * Karnofsky Score')
lines(lowess((actg_c$age * as.numeric(actg_c$karnof)), mres_mid))
```

That was a miss, its likely that the intuition is fine, but actually age and karnofsky score are highly correlated. Since this was a short study it's likely that overall health is more important that age. In the long run, age may cause complications with having a combined event of death and AIDS, but not here. Lets check covariance.


```{r, check covariance}
library(corrplot)

actg_c$karnof_num <- as.numeric(as.character(actg_c$karnof))
cont_var <- c("karnof_num", "priorzdv", "age", "base_cd4")
str(actg_c[, cont_var])
# draw Correlation Heatmap
correlation_matrix <- cor(actg_c[, cont_var], use = "complete.obs")
par(pin = c(6, 6))
corrplot(correlation_matrix, method = "color", 
         col = colorRampPalette(c("blue", "white", "red"))(200), 
         addCoef.col = "black", tl.col = "black", tl.srt = 45, number.cex = 0.8)
```


```{r cov of karnof and age and result}
boxplot(age ~ karnof, data = actg_c,
        main = 'Boxplots of Age by Karnofsky Score',
        xlab = 'Karnofsky Score',
        ylab = 'Age')
```

Those with the lower score are slightly older, but not by much to assume that there is great co-linearity between them, we should be fine keeping both variables.

Next, priorzdv may be a proxy for how long someone has had HIV, which could be an important measure in AIDS progression, but different to base_cd4. Lets see if they have high co-linearity.

```{r}
plot(actg_c$priorzdv, actg_c$base_cd4,
     xlim = c(0, 200),
     xlab = 'Prior ZDV',
     ylab = 'Base cd4',
     main = 'Plot of Base cd4 against Prior ZDV')
```

Again, there is no real pattern here between someone's baseline cd4 level and their prior months of ZDV usage, so there is no reason to believe they are having a strong effect on each other.

We can try now to see if an interaction term here is helpful, its reasonable that the effect of someones prior zdv usage on their survival depends on their baseline cd4 as someone with a higher cd4 should have a better time with the disease, but longer zdv implies longer time with HIV, which has detrimental effects on health outside of just cd4.

```{r}
summary(mid_cox_actg)
summary(coxph(surv_actg ~ tx + ivdrug_bin + (priorzdv * base_cd4) + age + karnof, data = actg_c))

plot((actg_c$priorzdv * actg_c$base_cd4), mres_mid,
     xlab = 'ZDV * Base cd4',
     ylab = 'Martingale Residuals',
     main = 'Martingale Residuals vs. ZDV Usage * Base cd4')
lines(lowess((actg_c$priorzdv * actg_c$base_cd4), mres_mid))
```

Again, no dice, an interaction term helps us not here.

```{r checking survival of mid model against tx model}
mid_df <- data.frame(tx = c(0, 1),
                     ivdrug_bin = c(0, 0),
                     karnof = c(mode_stat(actg_c$karnof[actg_c$tx == 0]), mode_stat(actg_c$karnof[actg_c$tx == 1])),
                     priorzdv = c(median(actg_c$priorzdv[actg_c$tx == 0]), median(actg_c$priorzdev[actg_c$tx == 1])),
                     age = c(mean(actg_c$age[actg_c$tx == 0]), mean(actg_c$age[actg_c$tx == 1])),
                     base_cd4 = c(median(actg_c$base_cd4[actg_c$tx == 0]), median(actg_c$base_cd4[actg_c$tx == 1])))

plot(survfit_actg, col = 1:2, lwd = 2, ylim = c(0.7, 1), main = 'Observed vs. Expected Survival (Mid Model)',
     xlab = 'Days',
     ylab = 'Survival Prob.')
lines(survfit(mid_cox_actg, mid_df, data = actg_c),
      col = 1:2, lwd = 2, lty = 2)
legend('bottomleft', c('SoC', 'SoC + Invidir'), col = 1:2, lwd = 2)

plot(survfit_actg, col = 1:2, lwd = 2, ylim = c(0.7, 1), main = 'Observed vs. Expected Survival (Large Model)',
     xlab = 'Days',
     ylab = 'Survival Prob.')
lines(survfit(large_cox_actg, large_model_df, data = actg_c),
      col = 1:2, lwd = 2, lty = 2)
legend('bottomleft', c('SoC', 'SoC + Invidir'), col = 1:2, lwd = 2)
```

Checking this mid-model against the larger model, we see that there is no discernible difference. We can't find any linearity issues in our variables, and there are no obvious combined effects to create to help with the model.

##############################################################################################################################

Summary so far: 

USE THE MID MODEL, I ALSO CREATED AN IVDRUG_BINARY VARIABLE AND MADE THIS THE MID MODEL

MAYBE base_cd4 violates the proportional hazards assumption, as we saw from its schoenfeld residuals, but overall model fit is pretty good, and none of the continuous covariates need a transformation it seems.

Look at stratification because of the base_cd4

Look for outliars with dfbeta and deviance residuals.

Look at removing priorzdv, I thought it would be clinically important but it seems like it may be really hurting the model.





###############################################
Yifan Updates
###############################################

start with model: [cox_reduced] surv_actg ~ tx + ivdrug_bin + karnof + age + base_cd4

```{r}
summary(cox_reduced)

cox_reduced_zph <- cox.zph(cox_reduced)
cox_reduced_zph
```

consider to stratify by base_cd4

```{r stratify by base_cd4}
actg_c$cd4_strata3 <- cut(
  actg_c$base_cd4,
  breaks = c(-Inf, 50, 200, Inf),
  labels = c("<=50", "51-200", ">200")
)

table(actg_c$cd4_strata3)

cox_strat3 <- coxph(
  surv_actg ~ tx + ivdrug_bin + karnof + age + strata(cd4_strata3),
  data = actg_c
)

summary(cox_strat3)
```

Since concordance of the stratified model is much smaller than the non-stratified one, we will not stratify by base_cd4. Besides, if we stratify the base_cd4, we will lose the "quantitative interpretation" of the crucial biological indicator CD4, since it only affect the baseline hazard function.


```{r}
cox_final <- cox_reduced
summary(cox_final)
```

**Interpretation:**
- The patients in the IDV group had significantly lower risks of developing AIDS or dying (improved survival);
- The patients who have drug use history had lower risks of developing AIDS or dying, but this is not significant;
- The patients with higher Karnofsky scores had significantly lower risks of developing AIDS or dying (improved survival);
- Older patients had higher risks of developing AIDS or dying (worse survival);
-  Patients with higher baseline CD4 counts had significantly lower risks of developing AIDS or dying (improved survival), especially, when base_cd4>100, the risk reduced by 75% (1-0.986^100).


```{r, consider interaction}
cox_int_cd4 <- coxph(
  surv_actg ~ tx*base_cd4 + ivdrug_bin + karnof + age,
  data = actg_c
)

summary(cox_int_cd4)
anova(cox_final, cox_int_cd4, test="LRT")
```

```{r, consider interaction}
cox_int_karnof <- coxph(
  surv_actg ~ tx*karnof + ivdrug_bin + karnof + age,
  data = actg_c
)

summary(cox_int_karnof)
anova(cox_final, cox_int_karnof, test="LRT")
```



```{r, test for ivdrug_bin}
fit_ivdrug <- survfit(Surv(time_event, event) ~ ivdrug_bin, data = actg_c)

plot(fit_ivdrug, col = 1:2, lwd = 2, ylim = c(0.85, 1.0), xlab = "Time (days)", ylab = "Survival")
title("KM Survival Curves for Drug use history")
legend("bottomleft", c("Never","Previous/Current"), col = 1:2, lwd = 2)

survdiff(Surv(time_event, event) ~ ivdrug_bin, data = actg_c)
```

The log-rank test comparing subjects with and without a history of intravenous drug use was not statistically significant (χ² = 1.6, p = 0.20).


```{r}
par(mfrow=c(1,3))

# 1. Baseline CD4 boxplot
boxplot(base_cd4 ~ factor(ivdrug_bin, labels=c("Never","Previous/Current")),
        data=actg_c,
        main = "Baseline CD4 by IV Drug Use",
        xlab = "IV Drug Use History",
        ylab = "Baseline CD4 Count",
        col = c("lightblue", "lightgreen"))

cd4_medians <- tapply(actg_c$base_cd4,
                      factor(actg_c$ivdrug_bin, labels=c("Never","Previous/Current")),
                      median)

text(1:2, cd4_medians + 20,          
     labels = round(cd4_medians, 1),
     col="black", cex=1)

# 2. Age boxplot
boxplot(age ~ factor(ivdrug_bin, labels=c("Never","Previous/Current")),
        data=actg_c,
        main = "Age by IV Drug Use",
        xlab = "IV Drug Use History",
        ylab = "Age",
        col = c("orange", "purple"))

age_medians <- tapply(actg_c$age,
                      factor(actg_c$ivdrug_bin, labels=c("Never","Previous/Current")),
                      median)

text(1:2, age_medians + 2.5,           
     labels = round(age_medians, 1),
     col="black", cex=1)


# 3. karnof
boxplot(karnof_num ~ factor(ivdrug_bin, labels=c("Never","Previous/Current")),
        data = actg_c,
        main = "Karnofsky Score by IV Drug Use",
        xlab = "IV Drug Use History",
        ylab = "Karnofsky Score",
        col = c("pink", "lightgray"))

# median karnofsky scores
karnof_num_medians <- tapply(actg_c$karnof_num,
                      factor(actg_c$ivdrug_bin, labels=c("Never","Previous/Current")),
                      median)

text(1:2, karnof_num_medians + 1.5,           
     labels = round(karnof_num_medians, 1),
     col="black", cex=1)


par(mfrow=c(1,1))
```


The KM curves appear to show slightly better survival among subjects with a history of intravenous drug use. However, this pattern does not imply that drug use is protective since the Mantel–Haenszel log-rank test does not show a statistically significant difference (p-value=0.2).


**Explanation:**

Individuals with a history of intravenous drug use who enroll in clinical trials are often already detoxified, receive more frequent medical monitoring, are diagnosed earlier, undergo more regular CD4 assessments, and begin treatment sooner. As a result, they tend to have higher baseline CD4 counts and better Karnofsky performance scores. In our dataset, only four participants are current IV drug users, which is far too few to meaningfully affect the group average. Therefore, the combined “previous/current” category is effectively dominated by previous users, who are generally healthier at baseline.



















```{r}
mres <- residuals(cox_final, type = "martingale")
plot(actg_c$base_cd4, mres,
     xlab = "Baseline CD4 Count",
     ylab = "Martingale Residuals",
     pch = 20, col = "black",
     main = "Martingale Residuals vs CD4")

lines(lowess(actg_c$base_cd4, mres), col = "blue", lwd = 2)
```




```{r}
mart_res <- residuals(cox_final, type = "martingale")
dev_res  <- residuals(cox_final, type = "deviance")
dfb_res  <- residuals(cox_final, type = "dfbeta")
lp       <- predict(cox_final) # linear predictor

# 2. Martingale residuals vs Linear Predictor
plot(lp, mart_res, xlab = "Linear Predictor", ylab = "Martingale Residual",
     ylim = c(-4,2), pch = 19, cex = 0.2)
title("Martingale Residuals vs. Linear Predictor")
text(lp, mart_res+0.2, labels = rownames(actg_c))
```


```{r}
# 3. deviance residuals vs. the linear predictor
plot(lp, dev_res, xlab = "Linear Predictor", ylab = "Deviance Residuals",
     ylim = c(-2.5,3.5), pch = 19, cex = 0.2)
title("Deviance Residuals vs. Linear Predictor")
text(lp, dev_res + 0.2, labels = rownames(actg_c))
```


```{r}
# 4. two dfbeta values by observation order
coef_names <- names(coef(cox_final))
colnames(dfb_res) <- coef_names

for (i in 1:ncol(dfb_res)) {
  plot(dfb_res[,i], xlab = "Observation Order", ylab = paste0("dfbeta for ", coef_names[i]), pch = 19, cex = 0.2)
  title(paste0("dfbeta Values by Observation Order for ", coef_names[i]))
  text(dfb_res[,i], labels = rownames(actg_c))
}
```


| Residuals / Influence | Observations to Examind        |
|----------------------|-------------------------------|
| Martingale Residuals | 638                |
| Deviance Residuals   | 371, 638        |
| dfbeta (tx)      |   6, 451, 610, 818, 923, 996                    |
| dfbeta (ivdrug_bin)   | 843, 1051, 1095             |
| dfbeta (karnof80)       | 633, 638, 671, 680        |
| dfbeta (karnof90)       | 633, 638, 671, 680                |
| dfbeta (karnof100)       | 633, 638, 671, 680                |
| dfbeta (age)       |  612, 638, 864, 996            |
| dfbeta (base_cd4)       | 410, 610, 637, 848, 962            |


Therefore, the most important observations to examine seem to be 610, 633, 638, 671, 680 and 996. 

```{r}
dfb_res[c(610, 633, 638, 671, 680, 996), ]
dev_res[c(610, 633, 638, 671, 680, 996)]
```


Since all the influential observations do not have extremely large dfbeta, these observation points have a very small impact on any regression coefficient.

From the results in deviance residuals, we can see that observation 610 has the largest deviance residual = 2.583991, and all the other influential observations have deviance residuals less than 2.5. Therefore, observation 610 may have a certain impact on the model fit.

```{r}
actg_c[c(610, 633, 638, 671, 680, 996),]
```












